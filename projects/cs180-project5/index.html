<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Project 5: Fun With Diffusion Models! | Ryan Liu's Homepage </title> <meta name="author" content="Ryan Liu"> <meta name="description" content="Play around with pretrained diffusion models and train one from scratch!"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://ryanliu30.github.io/projects/cs180-project5/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> Ryan Liu's Homepage </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item active"> <a class="nav-link" href="/projects/">projects <span class="sr-only">(current)</span> </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Project 5: Fun With Diffusion Models!</h1> <p class="post-description">Play around with pretrained diffusion models and train one from scratch!</p> </header> <article> <h1 id="introduction">Introduction</h1> <p>In this project, I implemented diffusion model training and inference, as well as creating interesting anagrams with pretrained diffusion models.</p> <h1 id="part-a-sampling-pretrained-models">Part A: Sampling Pretrained Models</h1> <h2 id="gaining-access-to-deepfloyd">Gaining Access to DeepFloyd</h2> <p>As a first step, let’s start with sampling with the DeepFloyd model with their infrastructure. We set the seed to <code class="language-plaintext highlighter-rouge">180</code> for reproducibility, and run the sampling process for the three text propts, “a man wearing a hat,” “a rocket ship,” and “an oil painting of a snowy mountain village,” for two different <code class="language-plaintext highlighter-rouge">num_inference_steps</code> of <code class="language-plaintext highlighter-rouge">20</code> and <code class="language-plaintext highlighter-rouge">50</code>. This sampling results are presented below:</p> <div class="row"> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">a man wearing a hat</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/stage_1_a_man_wearing_a_hat_20steps.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">a rocket ship</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/stage_1_a_rocket_ship_20steps.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">an oil painting of a snowy mountain village</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/stage_1_an_oil_painting_of_a_snowy_mountain_village_20steps.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> </div> <p style="text-align:center;">Stage one sampling results with 20 inference steps</p> <div class="row"> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">a man wearing a hat</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/stage_1_a_man_wearing_a_hat_50steps.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">a rocket ship</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/stage_1_a_rocket_ship_50steps.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">an oil painting of a snowy mountain village</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/stage_1_an_oil_painting_of_a_snowy_mountain_village_50steps.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> </div> <p style="text-align:center;">Stage one sampling results with 50 inference steps</p> <p>We can also upsample the images to <code class="language-plaintext highlighter-rouge">256x256</code> by passing them into the stage two encoder:</p> <div class="row"> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">a man wearing a hat</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/stage_2_a_man_wearing_a_hat_20steps.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">a rocket ship</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/stage_2_a_rocket_ship_20steps.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">an oil painting of a snowy mountain village</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/stage_2_an_oil_painting_of_a_snowy_mountain_village_20steps.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> </div> <p style="text-align:center;">Stage two sampling results with 20 inference steps</p> <div class="row"> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">a man wearing a hat</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/stage_2_a_man_wearing_a_hat_50steps.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">a rocket ship</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/stage_2_a_rocket_ship_50steps.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">an oil painting of a snowy mountain village</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/stage_2_an_oil_painting_of_a_snowy_mountain_village_50steps.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> </div> <p style="text-align:center;">Stage two sampling results with 50 inference steps</p> <p>We see that the qualities of the outputs are all good, even for the ones with fewer sampling steps. Furthermore, the content of the images matched well with the text prompt. This shows the incredible generation capability of diffusion models.</p> <h2 id="implementing-the-forward-process">Implementing the Forward Process</h2> <p>We first implement the forward diffusion process. This process is given by the mathematical equation:</p> \[x_t = \sqrt{\hat\alpha_t} x_0 + \sqrt{1 - \hat\alpha_t}\epsilon, \quad \epsilon\sim\mathcal N(0, 1)\] <p>With the test image, we can test out three different noise levels <code class="language-plaintext highlighter-rouge">[250, 500, 750]</code>:</p> <div class="row"> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">original</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/campanile.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">noise: 250</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/noisy_campanile_250.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">noise: 500</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/noisy_campanile_500.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">noise: 750</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/noisy_campanile_750.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> </div> <p style="text-align:center;"> Campanile forward process</p> <h2 id="classical-denoising">Classical Denoising</h2> <p>Using the fact that pixel-wise gaussian noise convolved with a gaussian kernel goes to zero as the kernel size increases (i.e. the expectation of gaussian noise is zero), we can remove the noise by applying a gaussian bluring in the price of hurting the images’ sharpness. Here, I use a gaussian kernel of size <code class="language-plaintext highlighter-rouge">9</code>. This value is adjusted by empirically assess the output images quality.</p> <div class="row"> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">original</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/campanile.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">blured noise 250</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/blured_campanile_250.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">blured noise 500</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/blured_campanile_500.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">blured noise 750</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/blured_campanile_750.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> </div> <p style="text-align:center;"> Classically denoised campanile</p> <p>We see that gaussian bluring can remove some noise but the effectiveness quickly goes down as the noise level goes up.</p> <h2 id="one-step-denoising">One-Step Denoising</h2> <p>With a trained diffusion model, we can try denoising by subtracting off the estimated noise. Recall that:</p> \[x_t = \sqrt{\hat\alpha_t} x_0 + \sqrt{1 - \hat\alpha_t}\epsilon, \quad \epsilon\sim\mathcal N(0, 1)\] <p>By rearranging the terms and replace the gaussian noise with the model’s estimate \(\hat \epsilon_\theta(x_t)\), we get:</p> \[\hat x_0 = \frac{x_t - \sqrt{1 - \hat\alpha_t}\hat \epsilon_\theta(x_t)}{\sqrt{\hat\alpha_t}}\] <p>We can visualize the estimated denoised images:</p> <div class="row"> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">original</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/campanile.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">one-step denoised 250</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/clean_campanile_250.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">one-step denoised 500</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/clean_campanile_500.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">one-step denoised 750</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/clean_campanile_750.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> </div> <p style="text-align:center;"> One-step denoised campanile</p> <p>We see that the denoised images’ quality are much better than the classically denoised one. Moreover, while with low noise level the model is able to denoised to almost identical results, the one with higher noise levels have different details than the original image. This is due to the irreversible loss of information during the forward process.</p> <h2 id="iterative-denoising">Iterative Denoising</h2> <p>Instead of denoising with only one-shot estimate, we can denoise the image iteratively by applying the formula:</p> \[\hat x_{t'} = \frac{\sqrt{\bar\alpha_{t'}}\beta_t}{1 - \bar\alpha_t}\hat x_0 + \frac{\sqrt{\alpha_t}(1-\bar\alpha_{t'})}{1 - \bar\alpha_t}x_t+v_{\sigma}(t, t')\] <p>where \(v_{\sigma}(t, t')\) is a gaussian random variable with variance as a funciton of \(t\) and \(t'\), and \(\hat x_0\) is the one-shot estimate as in the section before. The idea is that we can try removing some noise from the image, then add some but less noise back into the image. This makes the denoising process stochastic and we can gain some stability by doing so. The process is visualized below. We start at <code class="language-plaintext highlighter-rouge">t=690</code> (<code class="language-plaintext highlighter-rouge">i_start=10</code>).</p> <div class="row"> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">0th iteration</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/clean_campanile_step_10.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">5th iteration</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/clean_campanile_step_15.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">10th iteration</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/clean_campanile_step_20.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> </div> <div class="row"> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">15th iteration</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/clean_campanile_step_25.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">20th iteration</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/clean_campanile_step_30.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">22nd iteration (end)</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/clean_campanile_step_32.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> </div> <p style="text-align:center;"> Iteratively denoised campanile</p> <p>We can compare different methods of denoising:</p> <div class="row"> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">noised campanile</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/im_noisy_campanile.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">classically denoised</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/blur_filtered_campanile.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">one-step denoised</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/clean_one_step_campanile.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">iteratively denoised</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/clean_campanile.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> </div> <p style="text-align:center;"> Comparison of denoising methods </p> <p>We see that classical method produce very low quality results. The one-step method is able to reconstruct a significant portion of the original image but missed out some details. The iteratively denoised one has a lot details but they are different from the original image! (it “fills in the blank”).</p> <h2 id="diffusion-model-sampling">Diffusion Model Sampling</h2> <p>Instead of starting with a blurred image at some timestep, we can start at <code class="language-plaintext highlighter-rouge">t=990</code> and feed in pure noise to sample with the model. Some results are showned below:</p> <div class="row"> <div class="col-sm"> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/generated_0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/generated_1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/generated_2.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/generated_3.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/generated_4.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> </div> <p style="text-align:center;"> Some generated images </p> <p>They look like image, but not so satisfactory.</p> <h2 id="classifier-free-guidance-cfg">Classifier-Free Guidance (CFG)</h2> <p>To improve the sampled images’ quality, we can use classifier free guidance. The idea is that given an “unconditional” prediction of noise and a “conditional” prediction of noise, we can manually go “more conditioned” by deviating from the unconditional prediction more. Mathematically, it can be written as:</p> \[\epsilon = \epsilon_u + \gamma(\epsilon_c - \epsilon_u)\] <p>where \(\epsilon_u\) is the unconditional prediction and the \(\epsilon_c\) is the conditional prediction. We use “” as the unconditional prompt and “a high quality photo” for unconditional prompt. The \(\gamma\) is chosen to be <code class="language-plaintext highlighter-rouge">7</code>. Some samlping results are shown below:</p> <div class="row"> <div class="col-sm"> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/generated_cfg_0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/generated_cfg_1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/generated_cfg_2.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/generated_cfg_3.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/generated_cfg_4.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> </div> <p style="text-align:center;"> Some images generated with CFG</p> <p>Now the sampling results look a lot more like real photos.</p> <h2 id="image-to-image-translation">Image-to-image Translation</h2> <h3 id="sdedit">SDEdit</h3> <p>We can also feed in a partially corropted (noised) image and then denoise from it. With different level of noise added, the sampling result will gradually deviate from the original image. We can exploit this fact to produce some interesting edit of the original image. Here, we test it out with three images:</p> <div class="row"> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">original campanile</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/campanile.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">original oski</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/oski.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">original tree</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/tree.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> </div> <p style="text-align:center;"> Original images </p> <div class="row"> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">campanile from i=1</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/campanile_im2im_1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">campanile from i=3</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/campanile_im2im_3.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">campanile from i=5</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/campanile_im2im_5.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">campanile from i=7</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/campanile_im2im_7.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">campanile from i=10</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/campanile_im2im_10.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">campanile from i=20</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/campanile_im2im_20.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> </div> <p style="text-align:center;"> SDEdit campanile </p> <div class="row"> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">Oski from i=1</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/oski_im2im_1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">Oski from i=3</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/oski_im2im_3.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">Oski from i=5</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/oski_im2im_5.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">Oski from i=7</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/oski_im2im_7.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">Oski from i=10</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/oski_im2im_10.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">Oski from i=20</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/oski_im2im_20.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> </div> <p style="text-align:center;"> SDEdit Oski </p> <div class="row"> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">tree from i=1</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/tree_im2im_1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">tree from i=3</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/tree_im2im_3.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">tree from i=5</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/tree_im2im_5.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">tree from i=7</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/tree_im2im_7.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">tree from i=10</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/tree_im2im_10.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">tree from i=20</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/tree_im2im_20.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> </div> <p style="text-align:center;"> SDEdit tree </p> <p>We can see that SDEdit was able to produce some interesting edits of the original images while retaining the rough structure of them. In particular, it worked well for campanile. However, for oski and tree, it does not work that well except for i=20. This could be due to the fact that during training time images like Oski and the tree was not seen that frequently and since diffusion model is a density modeling, it tends to drag all images to its training distribution conditioned on the text prompt. Therefore, Oski and the tree deviates from the original image a lot.</p> <h2 id="sdedit-with-unrealistic-images">SDEdit with Unrealistic Images</h2> <div class="row"> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">original Gojo</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/gojo.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">original dog</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/handdrawn1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">original beach</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/handdrawn2.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> </div> <p style="text-align:center;"> Original images </p> <div class="row"> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">Gojo from i=1</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/gojo_im2im_1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">Gojo from i=3</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/gojo_im2im_3.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">Gojo from i=5</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/gojo_im2im_5.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">Gojo from i=7</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/gojo_im2im_7.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">Gojo from i=10</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/gojo_im2im_10.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">Gojo from i=20</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/gojo_im2im_20.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> </div> <p style="text-align:center;"> SDEdit Gojo </p> <div class="row"> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">dog from i=1</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/handdrawn1_im2im_1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">dog from i=3</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/handdrawn1_im2im_3.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">dog from i=5</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/handdrawn1_im2im_5.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">dog from i=7</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/handdrawn1_im2im_7.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">dog from i=10</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/handdrawn1_im2im_10.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">dog from i=20</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/handdrawn1_im2im_20.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> </div> <p style="text-align:center;"> SDEdit dog </p> <div class="row"> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">beach from i=1</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/handdrawn2_im2im_1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">beach from i=3</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/handdrawn2_im2im_3.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">beach from i=5</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/handdrawn2_im2im_5.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">beach from i=7</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/handdrawn2_im2im_7.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">beach from i=10</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/handdrawn2_im2im_10.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">beach from i=20</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/handdrawn2_im2im_20.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> </div> <p style="text-align:center;"> SDEdit beach </p> <p>We see that SDEdit works perfectly fine with unrealistic pictures. In particular, the beach image with only semantic coloring works the best. This is presumably due to the flexible yet informative conditioning that we provided to the model through the image.</p> <h3 id="inpainting">Inpainting</h3> <p>We can also inpaint an image with a diffusion model. This is done by keeping the context along the “true” noising trajectory throughout the process. Namely, with a mask that is 0 for the context and 1 for the inpainting region, we iteratively do:</p> \[x_t\leftarrow mx_t+(1-m)\mathrm{forward}(x_{orig}, t)\] <p>Here a few examples are presented:</p> <div class="row"> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">original campanile</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/campanile.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">campanile mask</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/mask.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">campanile to replace</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/to_replace.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">inpainted campanile</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/inpainting.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> </div> <p style="text-align:center;"> Inpainted campanile</p> <div class="row"> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">original Rick</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/rickroll.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">Rick mask</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/rick_mask.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">Rick to replace</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/rick_to_replace.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">inpainted Rick</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/rick_inpainting.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> </div> <p style="text-align:center;"> Inpainted Rick</p> <div class="row"> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">original Pepe</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/pepe.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">Pepe mask</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/pepe_mask.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">Pepe to replace</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/pepe_to_replace.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">inpainted Pepe</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/pepe_inpainting.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> </div> <p style="text-align:center;"> Inpainted Pepe</p> <p>With inpainting, we can create interesting edits of the original image wile keeping the context exactly the same as the original image. This allows us to do many cool things such as swapping out Rick’s head.</p> <h3 id="text-conditional-image-to-image-translation">Text-Conditional Image-to-image Translation</h3> <p>Finally, we can condition the SDEdit algorithm on some text prompt. This is done by simply feeding in some text to the diffusion model denoiser. Here are three examples:</p> <div class="row"> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">prompt: a rocket ship</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/campanile.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">prompt: a photo of a dog</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/oski.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">prompt: a pencil</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/tree.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> </div> <p style="text-align:center;"> Original images and prompts </p> <div class="row"> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">rocket ship from i=1</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/campanile_tim2im_1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">rocket ship from i=3</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/campanile_tim2im_3.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">rocket ship from i=5</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/campanile_tim2im_5.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">rocket ship from i=7</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/campanile_tim2im_7.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">rocket ship from i=10</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/campanile_tim2im_10.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">rocket ship from i=20</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/campanile_tim2im_20.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> </div> <p style="text-align:center;"> Text-conditioned rocket ship from campanile </p> <div class="row"> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">dog from i=1</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/oski_tim2im_1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">dog from i=3</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/oski_tim2im_3.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">dog from i=5</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/oski_tim2im_5.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">dog from i=7</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/oski_tim2im_7.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">dog from i=10</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/oski_tim2im_10.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">dog from i=20</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/oski_tim2im_20.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> </div> <p style="text-align:center;"> Text-conditioned dog from Oski </p> <div class="row"> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">tree from i=1</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/tree_tim2im_1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">tree from i=3</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/tree_tim2im_3.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">tree from i=5</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/tree_tim2im_5.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">tree from i=7</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/tree_tim2im_7.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">tree from i=10</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/tree_tim2im_10.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">tree from i=20</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/tree_tim2im_20.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> </div> <p style="text-align:center;"> Text-conditioned pencil from tree </p> <p>Similar to the case before, campanile works the best while the latter two deviates from the original images a lot. Nevertheless, they are still conditioned well and successfully produced an edit that is controlled by the prompt.</p> <h2 id="visual-anagrams">Visual Anagrams</h2> <p>A very cool application of diffusion model is to use it to produce visual anagrams. To do so, we prepare two prompts. For the normal prompt we predict one estimate of noise. For the flipped prompt we predict one estimate based on the flipped image. The total estimate of noise is the average of the flipped estimates and the original estimates. This can be used in conjuction with CFG. Mathematically, it can we expressed as:</p> \[\hat\epsilon = \frac12 \left(\hat\epsilon_\theta(x, \mbox{“”}) + \gamma(\hat\epsilon_\theta(x, \mbox{normal}) - \hat\epsilon_\theta(x, \mbox{“”})) + \mathbf F\hat\epsilon_\theta(\mathbf Fx, \mbox{“”}) + \gamma(\mathbf F\hat\epsilon_\theta(\mathbf Fx, \mbox{flipped}) - \mathbf F\hat\epsilon_\theta(\mathbf Fx, \mbox{“”})) \right)\] <p>where \(\mathbf F\) is the flipping operator. I generated three examples of visual anagrams:</p> <div class="row"> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">an oil painting of people around a campfire</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/anagram_fire.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">a photo of a monkey</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/anagram_monkey.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">a photo of a wine glass</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/anagram_wine.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> </div> <div class="row"> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">an oil painting of an old man</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/anagram_fire_flipped.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">a photo of a programmer</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/anagram_monkey_flipped.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">a photo of a dress</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/anagram_wine_flipped.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> </div> <p style="text-align:center;"> Visual anagrams </p> <p>The anagrams are quite impressive! This very simple method can produce high quality anagram is a great indication of the robustness of stochastic processes.</p> <h2 id="hybrid-images">Hybrid Images</h2> <p>Finally, we can try to produce hybrid images. Similar to the idea of visual anagrams, we produce two sets of predictions with two prompts. They are passed through high and low pass filters respectively, and then sum together. When applying CFG, since these high and low pass filters combined becomes identity, we can simply do:</p> \[\hat\epsilon_c = f_{high}(\hat\epsilon_\theta(x, \mbox{high})) + f_{low}(\hat\epsilon_\theta(x, \mbox{low}))\] \[\hat\epsilon = \hat\epsilon_\theta(x, \mbox{“”}) + \gamma(\hat\epsilon_c - \hat\epsilon_\theta(x, \mbox{“”}))\] <p>Some examples are:</p> <div class="row"> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">low prompt: a lithograph of a skull <br> high prompt: a lithograph of waterfalls</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/hybrid_skull_waterfall.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">low prompt: a picture of a concert <br> high prompt: a picture of sunset</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/hybrid_concert_sunset.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="col-sm"> <p style="text-align:center;font-size: 12px;">low prompt: a photo of karaage <br> high prompt: a photo of poodles</p> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/hybrid_karaage_poodles.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> </div> <p style="text-align:center;"> Hybrid images </p> <p>It does a reasonably good job on producing these hybrid images. However, we that karaage and poodles worked better than sunset and concert. This could be suggesting that we need closer prompts for this to work better.</p> <h1 id="part-b-training-a-diffusion-model-from-scratch">Part B: Training a Diffusion Model from Scratch</h1> <h2 id="training-a-single-step-denoising-unet">Training a Single-Step Denoising UNet</h2> <h3 id="implementing-the-unet">Implementing the UNet</h3> <p>To implement the UNet, I followed exactly the architecture specified in the spec. That is:</p> <div class="row"> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/unet.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>The only twist I made is that in the <code class="language-plaintext highlighter-rouge">__init__</code> function, I compiled the model with <code class="language-plaintext highlighter-rouge">nn.Module.compile()</code> to get better performance.</p> <h3 id="using-the-unet-to-train-a-denoiser">Using the UNet to Train a Denoiser</h3> <p>To train a UNet denoiser, we first need to produce some noised image. When loading the images from MNIST dataset, we pass in a transformation of <code class="language-plaintext highlighter-rouge">ToTensor()</code> to convert pixel values into float in <code class="language-plaintext highlighter-rouge">[0, 1]</code>. After this, noising is simply adding a same shaped gaussian noise of \(\sigma\) variance. The noised images look like:</p> <div class="row"> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/noisy_mnist.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>We can then proceed to train a UNet denoiser by simply regressing to the original image given the noised image as input. One thing we should do before start training is normalization. We can normalize the image by subtracting the mean and dividing by the standard deviation. As the image has a range <code class="language-plaintext highlighter-rouge">[0, 1]</code>, to avoid calculating the true mean and variance, I estimated it to be a uniform distribution in its range and thus have mean of <code class="language-plaintext highlighter-rouge">0.5</code> and variance of <code class="language-plaintext highlighter-rouge">1/12</code>. After noising the mean is not changed by the variance becomes <code class="language-plaintext highlighter-rouge">1/12+sigma^2</code>.</p> <p>With the normalization in place, we can start training the model. We train with batch size of 256 for 5 epochs with constant learning rate of <code class="language-plaintext highlighter-rouge">1e-4</code>. This gives a training curve of:</p> <div class="row"> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/training_curve_unconditional.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>And the denoising results on test set are:</p> <div class="row"> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/unconditional_results.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>The UNet does a decent job denoising the images.</p> <p>We can also test on out-of-distribution by adding different values of noise. Note that when we change the <code class="language-plaintext highlighter-rouge">sigma</code>, the normalizer’s <code class="language-plaintext highlighter-rouge">sigma</code> should not be changed from the training value. The results look like:</p> <div class="row"> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/unconditional_ood_results.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>As we can see, the model generalized well to smaller variances but not larger ones.</p> <h2 id="training-a-diffusion-model">Training a Diffusion Model</h2> <p>To train a diffusion model, several changes need to be made. Firstly, we need to implement the vairance schedule. The variance schedule defines forward and backward process, namely,</p> \[x_t = \sqrt{\bar\alpha_t} x_0 + \sqrt{1 - \bar\alpha_t}\epsilon,\quad\epsilon\sim\mathcal N(0, 1)\] <p>and the sampling (backward) process is defined by:</p> <div class="row"> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/sampling.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>in our project, \(\beta_t\) is defined to be even interval sequence from <code class="language-plaintext highlighter-rouge">1e-4</code> to <code class="language-plaintext highlighter-rouge">2e-2</code>. \(\alpha_t\) defined to be \(1 - beta_t\), and \(\hat\alpha_t\) defined to be the cumulative product of \(\alpha_t\).</p> <p>The last tweak to the denoiser UNet in previous section is that now we need to condition our network by time embedding, which will be elaborate later.</p> <h3 id="adding-time-conditioning-to-unet">Adding Time Conditioning to UNet</h3> <p>To add time embedding, we add two fully connected blocks (i.e. MLPs) to our model. The embedding they produced are added to the channel dimension of the up-sampled arrays of the unet. The idea is that it will condition the high-level semantics by the time information.</p> <div class="row"> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/conditioned_unet.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <h3 id="training-the-unet">Training the UNet</h3> <p>We train the network with the DDPM algorithm:</p> <div class="row"> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/training.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>With the normalization in place, we can start training the model. We train with batch size of 128 for 20 epochs with exponentially decayed learning rate starting from <code class="language-plaintext highlighter-rouge">1e-3</code> and decaying to <code class="language-plaintext highlighter-rouge">1e-4</code>. This gives a training curve of:</p> <div class="row"> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/training_curve_time_conditional.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <h3 id="sampling-from-the-unet">Sampling from the UNet</h3> <p>Now we can sample from the UNet with the algorithm layed out in previous section. Using the checkpoints from the 5th and 20th epoch, we obtain the results:</p> <div class="row"> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/time_conditional_samples_epoch_5.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p style="text-align:center;"> 40 images sampled by checkpoint at epoch 5 </p> <div class="row"> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/time_conditional_samples_epoch_20.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p style="text-align:center;"> 40 images sampled by checkpoint at epoch 20 </p> <p>We see that the results from 20th epoch is better than 5th epoch, but still not perfect.</p> <h3 id="adding-class-conditioning-to-unet">Adding Class-Conditioning to UNet</h3> <p>We can improve our modeling by conditioning on the class (digit label). This can be done by adding yet another fully connected block. However, as the input is categorical, it can be fully described by an <code class="language-plaintext highlighter-rouge">nn.Embedding</code> module. We initialie a 11 class embedding, where the 11th class is the “unconditioned” class. Then, instead of adding to the up-sampled channels, we multiply them to the up-sampled channels (“gating” in machine learning terms). This is just a design choice and is emprically better (did an ablation and the training loss is lower than adding). The training procedure is identical to the time conditioned one, except for that we feed in classes as the conditions. Furthermore, we generate a Bernoulli random variate with probablity of 0.1 to change the class label to “unconditioned” label for all samples. This allows us to do CFG later. The optimizer parameters are the same as before and it gives a training curve like:</p> <div class="row"> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/training_curve_class_conditional.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <h3 id="sampling-from-the-class-conditioned-unet">Sampling from the Class-Conditioned UNet</h3> <p>Finally, we can sample from the class-conditioned UNet. The procedure is similar to the previous part, with the twist that we use CFG to improve the conditioning. Using the checkpoints from 5th and 20th epoch, we are able to sample:</p> <div class="row"> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/class_conditional_samples_epoch_5.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p style="text-align:center;"> 40 images sampled by checkpoint at epoch 5 </p> <div class="row"> <div style="margin:0 auto;"> <figure> <picture> <img src="/assets/img/180-project5/class_conditional_samples_epoch_20.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p style="text-align:center;"> 40 images sampled by checkpoint at epoch 20 </p> <p>We see that class conditioning is very strong and successfully forced the sampled images to be the desired class.</p> </article> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2024 Ryan Liu. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?06cae41083477f121be8cd9797ad8e2f"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.min.js" integrity="sha256-rjmgmaB99riUNcdlrDtcAiwtLIojSxNyUFdl+Qh+rB4=" crossorigin="anonymous"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>addBackToTop();</script> <script type="module" src="/assets/js/search/ninja-keys.min.js?601a2d3465e2a52bec38b600518d5f70"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script>let searchTheme=determineComputedTheme();const ninjaKeys=document.querySelector("ninja-keys");"dark"===searchTheme?ninjaKeys.classList.add("dark"):ninjaKeys.classList.remove("dark");const openSearchModal=()=>{const e=$("#navbarNav");e.hasClass("show")&&e.collapse("hide"),ninjaKeys.open()};</script> <script>const ninja=document.querySelector("ninja-keys");ninja.data=[{id:"nav-about",title:"about",section:"Navigation",handler:()=>{window.location.href="/"}},{id:"nav-publications",title:"publications",description:"publications by categories in reversed chronological order. generated by jekyll-scholar.",section:"Navigation",handler:()=>{window.location.href="/publications/"}},{id:"nav-projects",title:"projects",description:"Some cool projects did in class",section:"Navigation",handler:()=>{window.location.href="/projects/"}},{id:"nav-repositories",title:"repositories",description:"Selected Github repositories",section:"Navigation",handler:()=>{window.location.href="/repositories/"}},{id:"nav-cv",title:"cv",description:"This is a description of the page. You can modify it in '_pages/cv.md'. You can also change or remove the top pdf download button.",section:"Navigation",handler:()=>{window.location.href="/cv/"}},{id:"post-google-gemini-updates-flash-1-5-gemma-2-and-project-astra",title:"Google Gemini updates: Flash 1.5, Gemma 2 and Project Astra",description:"We\u2019re sharing updates across our Gemini family of models and a glimpse of Project Astra, our vision for the future of AI assistants.",section:"Posts",handler:()=>{window.open("https://blog.google/technology/ai/google-gemini-update-flash-ai-assistant-io-2024/","_blank")}},{id:"post-displaying-external-posts-on-your-al-folio-blog",title:"Displaying External Posts on Your al-folio Blog",description:"",section:"Posts",handler:()=>{window.open("https://medium.com/@al-folio/displaying-external-posts-on-your-al-folio-blog-b60a1d241a0a?source=rss-17feae71c3c4------2","_blank")}},{id:"news-a-simple-inline-announcement-with-markdown-emoji-sparkles-smile",title:'A simple inline announcement with Markdown emoji! <img class="emoji" title=":sparkles:" alt=":sparkles:" src="https://github.githubassets.com/images/icons/emoji/unicode/2728.png" height="20" width="20"> <img class="emoji" title=":smile:" alt=":smile:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f604.png" height="20" width="20">',description:"",section:"News"},{id:"news-a-long-announcement-with-details",title:"A long announcement with details",description:"",section:"News",handler:()=>{window.location.href="/news/announcement_2/"}},{id:"news-a-simple-inline-announcement",title:"A simple inline announcement.",description:"",section:"News"},{id:"projects-final-project-neural-radiance-field-nerf",title:"Final Project: Neural Radiance Field (NeRF)",description:"Rendering Novel 3D Views with NeRF",section:"Projects",handler:()=>{window.location.href="/projects/cs180-project-nerf/"}},{id:"projects-project-1-images-of-the-russian-empire",title:"Project 1: Images of the Russian Empire",description:"Colorizing the Prokudin-Gorskii photo collection",section:"Projects",handler:()=>{window.location.href="/projects/cs180-project1/"}},{id:"projects-project-2-fun-with-filters-and-frequencies",title:"Project 2: Fun with Filters and Frequencies!",description:"Image morphing, blending, and more!",section:"Projects",handler:()=>{window.location.href="/projects/cs180-project2/"}},{id:"projects-project-3-face-morphing",title:"Project 3: Face Morphing!",description:"Morphing faces with affine wrapping and cross dissolve",section:"Projects",handler:()=>{window.location.href="/projects/cs180-project3/"}},{id:"projects-project-4-image-warping-and-mosaicing",title:"Project 4: Image Warping and Mosaicing!",description:"Stitching Photo Mosaics",section:"Projects",handler:()=>{window.location.href="/projects/cs180-project4/"}},{id:"projects-project-5-fun-with-diffusion-models",title:"Project 5: Fun With Diffusion Models!",description:"Play around with pretrained diffusion models and train one from scratch!",section:"Projects",handler:()=>{window.location.href="/projects/cs180-project5/"}},{id:"socials-email",title:"Send email",section:"Socials",handler:()=>{window.open("mailto:%6C%69%75%72%79%61%6E%33%30@%62%65%72%6B%65%6C%65%79.%65%64%75","_blank")}},{id:"socials-google-scholar",title:"Google Scholar",section:"Socials",handler:()=>{window.open("https://scholar.google.com/citations?user=SB_HWdIAAAAJ","_blank")}},{id:"socials-github",title:"GitHub",section:"Socials",handler:()=>{window.open("https://github.com/ryanliu30","_blank")}},{id:"socials-linkedin",title:"LinkedIn",section:"Socials",handler:()=>{window.open("https://www.linkedin.com/in/ryan-liu-4785441bb","_blank")}},{id:"socials-rss",title:"RSS Feed",section:"Socials",handler:()=>{window.open("/feed.xml","_blank")}},{id:"light-theme",title:"Change theme to light",description:"Change the theme of the site to Light",section:"Theme",handler:()=>{setThemeSetting("light")}},{id:"dark-theme",title:"Change theme to dark",description:"Change the theme of the site to Dark",section:"Theme",handler:()=>{setThemeSetting("dark")}},{id:"system-theme",title:"Use system default theme",description:"Change the theme of the site to System Default",section:"Theme",handler:()=>{setThemeSetting("system")}}];</script> <script src="/assets/js/shortcut-key.js"></script> </body> </html>